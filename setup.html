<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Happy Hands Hideaway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif']
                    },
                    colors: {
                        paper: '#f5f1eb',
                        ink: '#4a3f35',
                        header: '#d8cfc4',
                        hero: '#bfa98a',
                        accent: '#7a5c3c'
                    }
                }
            }
        }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABF1urMF9QHnQK3glaphVAxDYi3eiv8Nc",
            authDomain: "happy-hands-a2927.firebaseapp.com",
            databaseURL: "https://happy-hands-a2927-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "happy-hands-a2927",
            storageBucket: "happy-hands-a2927.firebasestorage.app",
            messagingSenderId: "245124696893",
            appId: "1:245124696893:web:55de882f935bfb07cb5354"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.saveGitHubConfig = async function() {
            const token = document.getElementById('token').value.trim();
            const username = document.getElementById('username').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const imagePath = document.getElementById('imagePath').value.trim();
            const feedback = document.getElementById('feedback');

            if (!token || !username || !repo) {
                feedback.innerHTML = '<p class="text-red-700">❌ Please fill in all required fields</p>';
                return;
            }

            try {
                feedback.innerHTML = '<p class="text-blue-700">⏳ Saving configuration...</p>';
                
                const settingsRef = ref(db, 'settings/github');
                
                // Try to save with Firebase SDK first
                try {
                    await set(settingsRef, {
                        token: token,
                        username: username,
                        repo: repo,
                        imagePath: imagePath || 'images'
                    });
                    
                    // Success via SDK
                    feedback.innerHTML = '<p class="text-green-700">✓ GitHub configuration saved successfully! Redirecting to admin panel...</p>';
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 1500);
                } catch (sdkError) {
                    console.warn('Direct write failed, trying REST API...', sdkError);
                    
                    // Fallback: Try REST API
                    const response = await fetch('https://happy-hands-a2927-default-rtdb.europe-west1.firebasedatabase.app/settings/github.json', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: token,
                            username: username,
                            repo: repo,
                            imagePath: imagePath || 'images'
                        })
                    });
                    
                    if (response.ok) {
                        feedback.innerHTML = '<p class="text-green-700">✓ GitHub configuration saved via REST API! Redirecting to admin panel...</p>';
                        setTimeout(() => {
                            window.location.href = 'admin.html';
                        }, 1500);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'REST API write failed');
                    }
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                
                // Provide fallback instructions
                const fallbackCmd = `db.ref('settings/github').set({token:'${token}',username:'${username}',repo:'${repo}',imagePath:'${imagePath || 'images'}'})`;
                feedback.innerHTML = `
                    <div class="text-red-700">
                        <p class="font-bold mb-2">❌ Firebase configuration failed.</p>
                        <p class="text-sm mb-3">Error: ${error.message}</p>
                        <p class="text-xs bg-red-50 p-2 rounded mb-2">The Firebase database might have restricted access. Try opening the browser console on this page and running:</p>
                        <div class="bg-gray-800 text-gray-100 p-2 rounded font-mono text-xs overflow-x-auto mb-2" id="fallbackCode"></div>
                        <p class="text-xs">Then refresh the page and try again.</p>
                    </div>
                `;
                
                // Add the fallback command to the display
                document.getElementById('fallbackCode').textContent = fallbackCmd;
            }
        }
    </script>
</head>
<body class="bg-paper text-ink font-poppins min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full">
        <h1 class="text-3xl font-bold mb-2">Setup</h1>
        <p class="text-gray-600 mb-6">Configure GitHub credentials for image uploads</p>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">GitHub Personal Access Token *</label>
                <input id="token" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-accent focus:outline-none">
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">GitHub Username *</label>
                <input id="username" type="text" placeholder="your-github-username" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-accent focus:outline-none">
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Repository Name *</label>
                <input id="repo" type="text" placeholder="happy-hands-hideaway" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-accent focus:outline-none">
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Image Folder Path</label>
                <input id="imagePath" type="text" placeholder="images" value="images" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-accent focus:outline-none">
            </div>

            <button onclick="window.saveGitHubConfig()" class="w-full bg-hero text-white font-semibold py-3 rounded-lg hover:bg-accent transition mt-6">
                Save Configuration
            </button>

            <div id="feedback" class="min-h-6"></div>
        </div>

        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200 text-sm text-blue-900">
            <p><strong>ℹ️ Note:</strong> This configuration is saved in your Firebase database and used by the admin panel for secure image uploads.</p>
        </div>
    </div>
</body>
</html>
